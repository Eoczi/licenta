<html>
  <head>
    <title>SavorSim</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>
      delete AFRAME.components["grabbable"];
    </script>
    <script src="https://unpkg.com/aframe-event-set-component@4.2.1/dist/aframe-event-set-component.min.js"></script>
    <script src="https://unpkg.com/super-hands@^3.0.4/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.1.0/dist/aframe-physics-system.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script>
    
    <script>
      AFRAME.registerComponent('phase-shift', {
        init: function () {
          var el = this.el
          el.addEventListener('gripdown', function () {
            el.setAttribute('collision-filter', {collisionForces: true})
            console.log("debug");
          })
          el.addEventListener('gripup', function () {
            el.setAttribute('collision-filter', {collisionForces: false})
            console.log("debug");
          })
        }
      });
      AFRAME.registerComponent('knob-turn', {
        init: function () {
          var el = this.el;
          var knobId = el.getAttribute('id');
          var burnerIndex = knobId[knobId.length - 1];
          
          el.addEventListener('grab-start', function () {
            var currentRotation = el.getAttribute('rotation');
            if (currentRotation.x === 0 && currentRotation.y === 0 && currentRotation.z === 0) {
              el.setAttribute('animation', {
                property: 'rotation',
                from: '0 0 0',
                to: '0 180 0',
                loop: false,
                dur: 1000
              });
              el.addEventListener('animationcomplete', function () {
                this.emit('hot', { index: burnerIndex });
              });
            }
            else {
              el.setAttribute('animation', {
                property: 'rotation',
                from: '0 180 0',
                to: '0 0 0',
                loop: false,
                dur: 1000
              });
              el.addEventListener('animationcomplete', function () {
                this.emit('cold', { index: burnerIndex });
              });
            }
          });
        }
      });
      AFRAME.registerComponent('on-off', {
        init: function () {
          var el = this.el;
          var burner = document.getElementsByClassName('burner');

          el.addEventListener('hot', function (event) {
            var burnerIndex = event.detail.index;
            burner[burnerIndex].setAttribute('animation', {
              property: 'color',
              from: '#000000',
              to: '#FF0000',
              dur: 2000
            });
          });

          el.addEventListener('cold', function (event) {
            var burnerIndex = event.detail.index;
            burner[burnerIndex].setAttribute('animation', {
              property: 'color',
              from: '#FF0000',
              to: '#000000',
              dur: 2000
            });
          });
        }
      });
      AFRAME.registerComponent('add-body', {
        init: function() {
          var el= this.el;
          
          el.addEventListener('model-loaded', function () {
            el.setAttribute('static-body', '');
          });
        }
      });
    </script>
  </head>
  <body>
    <a-scene physics>
      <a-assets>
        <a-asset-item id="knob-gltf" src="assets/models/knob.gltf"></a-asset-item>
        <a-asset-item id="knob-obj" src="assets/models/knob.obj"></a-asset-item>
        <a-asset-item id="knob-mtl" src="assets/models/knob.mtl"></a-asset-item> 

        <a-mixin id="interactable"
          class="interactable"
          hoverable grabbable draggable
          event-set__hoveron="_event: hover-start; material.opacity: 0.7; transparent: true"
          event-set__hoveroff="_event: hover-end; material.opacity: 1; transparent: false"
        ></a-mixin>
        <a-mixin
          id="physics-hand"
          physics-collider phase-shift
          collision-filter="collisionForces: false"
          static-body="shape: sphere; sphereRadius: 0.02"
          super-hands="colliderEvent: collisions;
                      colliderEventProperty: els;
                      colliderEndEvent: collisions;
                      colliderEndEventProperty: clearedEls;">
        </a-mixin>
        <a-mixin id="knob"
          obj-model="obj: #knob-obj"
          add-body knob-turn on-off
          scale="0.25 0.25 0.25">
        </a-mixin>
        <a-mixin id="burner"
          geometry="primitive: cylinder; height: 0.1; radius: 1"
          material="color: black"
          scale="0.25 0.25 0.25">
        </a-mixin>
        
      </a-assets>

      <a-entity>
        <a-entity id="#rhand" mixin="physics-hand" hand-controls="hand: right"></a-entity>
        <a-entity id="#lhand" mixin="physics-hand" hand-controls="hand: left"></a-entity>
      </a-entity>

      <a-entity position="0 0 3" rotation="0 0 0">
        <a-camera look-controls>
          <a-cursor raycaster="objects: .interactable"
            fuse="true"
            fuseTimeout="500"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.006"
            material="color: black; shader: flat">
          </a-cursor>
        </a-camera>
      </a-entity>

      <a-box id="#backwall" position="-7.5 1.5 0" width="1" height="3" depth="15" color="white"></a-box>
      <a-box id="#leftwall" position="7.5 1.5 0" width="1" height="3" depth="15" color="white"></a-box>
      <a-box id="#rightwall" position="0 1.5 -7.5" width="15" height="3" depth="1" color="white"></a-box>
      <a-box id="#frontwall" position="0 4.5 7.5" width="15" height="3" depth="1" color="white"></a-box>
      <a-box static-body id="#table" position="0 0.25 -2.5" width="5" depth="3" height="0.5" color="grey">
        <a-box id="#table-top" position="0 0.325 0"  width="6" depth="3.5" height="0.15" color="grey"></a-box>
      </a-box>
      <a-entity position="-1 0.65 -2" >
        <a-entity id="#knob0" mixin="interactable knob" position="0.5 0 0"></a-entity>
        <a-entity id="#knob1" mixin="interactable knob" position="0.5 0 -1" ></a-entity>
        <a-entity id="#knob2" mixin="interactable knob" position="-1.5 0 0"></a-entity>
        <a-entity id="#knob3" mixin="interactable knob" position="-1.5 0 -1" > </a-entity>
        <a-cylinder id="#burner0" class="burner" mixin="burner" position="0 0 0"></a-cylinder>
        <a-cylinder id="#burner1" class="burner" mixin="burner" position="0 0 -1"></a-cylinder>
        <a-cylinder id="#burner2" class="burner" mixin="burner" position="-1 0 0"></a-cylinder>
        <a-cylinder id="#burner3" class="burner" mixin="burner" position="-1 0 -1"></a-cylinder>
      </a-entity>

      <a-plane static-body material="color: #7BC8A4" position="0 -0.01 0" rotation="-90 0 0" scale="1000 1000 1" ></a-plane>
      
      <a-sky color="#ECECEC"></a-sky>
    </a-scene>
    
  </body>
</html>